# SQL Í∞úÎÖêÏ†ïÎ¶¨ - Í≥µÏãùÎ¨∏ÏÑú Ï∞∏Í≥†
## 14.20.2 Window Function Concepts and Syntax
[Í≥µÏãùÎ¨∏ÏÑú](https://dev.mysql.com/doc/refman/8.0/en/window-functions-usage.html)

- A window function performs an aggregate-like operation on a set of query rows.
-  However, whereas an aggregate operation groups query rows into a single result row,
a window function produces a result for each query row.
- window operations do not collapse groups of query rows to a single output row.
Instead, they produce a result for each row.

```SQL
mysql> SELECT
         year, country, product, profit,
         SUM(profit) OVER() AS total_profit,
         SUM(profit) OVER(PARTITION BY country) AS country_profit
       FROM sales
       ORDER BY country, year, product, profit;

+------+---------+------------+--------+--------------+----------------+
| year | country | product    | profit | total_profit | country_profit |
+------+---------+------------+--------+--------------+----------------+
| 2000 | Finland | Computer   |   1500 |         7535 |           1610 |
| 2000 | Finland | Phone      |    100 |         7535 |           1610 |
| 2001 | Finland | Phone      |     10 |         7535 |           1610 |
| 2000 | India   | Calculator |     75 |         7535 |           1350 |
| 2000 | India   | Calculator |     75 |         7535 |           1350 |
| 2000 | India   | Computer   |   1200 |         7535 |           1350 |
| 2000 | USA     | Calculator |     75 |         7535 |           4575 |
| 2000 | USA     | Computer   |   1500 |         7535 |           4575 |
| 2001 | USA     | Calculator |     50 |         7535 |           4575 |
| 2001 | USA     | Computer   |   1200 |         7535 |           4575 |
| 2001 | USA     | Computer   |   1500 |         7535 |           4575 |
| 2001 | USA     | TV         |    100 |         7535 |           4575 |
| 2001 | USA     | TV         |    150 |         7535 |           4575 |
+------+---------+------------+--------+--------------+----------------+
```

### nonaggregate function
- uses ROW_NUMBER()
- it produces the row number of each row within its partition.

> NOTE : Partitioning for window functions differs from table partitioning.

- ROW_NUMBER() over_clause
	- To assign peers the same value, use RANK() or DENSE_RANK().
	- Returns the number of the current row within its partition.

## 14.20.1 Window Function Descriptions
[Í≥µÏãùÎ¨∏ÏÑú](https://dev.mysql.com/doc/refman/8.0/en/window-function-descriptions.html)

### [Table 14.30] Window Functions 

![show](../Images1/w2_5.png)


- CUME_DIST() over_clause
	- Returns the cumulative distribution of a value within a group of values.
	- the percentage of partition values less than or equal to the value in the current row.
	- This function should be used with ORDER BY to sort partition rows into the desired order.

```SQL
mysql> SELECT
         val,
         ROW_NUMBER()   OVER w AS 'row_number',
         CUME_DIST()    OVER w AS 'cume_dist',
         PERCENT_RANK() OVER w AS 'percent_rank'
       FROM numbers
       WINDOW w AS (ORDER BY val);
+------+------------+--------------------+--------------+
| val  | row_number | cume_dist          | percent_rank |
+------+------------+--------------------+--------------+
|    1 |          1 | 0.2222222222222222 |            0 |
|    1 |          2 | 0.2222222222222222 |            0 |
|    2 |          3 | 0.3333333333333333 |         0.25 |
|    3 |          4 | 0.6666666666666666 |        0.375 |
|    3 |          5 | 0.6666666666666666 |        0.375 |
|    3 |          6 | 0.6666666666666666 |        0.375 |
|    4 |          7 | 0.8888888888888888 |         0.75 |
|    4 |          8 | 0.8888888888888888 |         0.75 |
|    5 |          9 |                  1 |            1 |
+------+------------+--------------------+--------------+
```

- DENSE_RANK() over_clause
	- Returns the cumulative distribution of a value within a group of values.
	- Peers are considered ties and receive the same rank.


- LAG(expr [, N[, default]]) [null_treatment] over_clause
	- Returns the value of expr from the row that lags (precedes) the current row by N rows within its partition.

- LEAD(expr [, N[, default]]) [null_treatment] over_clause
	- Returns the value of expr from the row that leads (follows) the current row by N rows within its partition.

- RANK() over_clause
	- Returns the rank of the current row within its partition, with gaps.
	- the result is noncontiguous rank numbers.

### ÏµúÏ¢Ö ÎπÑÍµê ÏøºÎ¶¨
```SQL
mysql> SELECT
         val,
         ROW_NUMBER() OVER w AS 'row_number',
         RANK()       OVER w AS 'rank',
         DENSE_RANK() OVER w AS 'dense_rank'
       FROM numbers
       WINDOW w AS (ORDER BY val);
+------+------------+------+------------+
| val  | row_number | rank | dense_rank |
+------+------------+------+------------+
|    1 |          1 |    1 |          1 |
|    1 |          2 |    1 |          1 |
|    2 |          3 |    3 |          2 |
|    3 |          4 |    4 |          3 |
|    3 |          5 |    4 |          3 |
|    3 |          6 |    4 |          3 |
|    4 |          7 |    7 |          4 |
|    4 |          8 |    7 |          4 |
|    5 |          9 |    9 |          5 |
+------+------------+------+------------+
```



## 14.19.1 Aggregate Function Descriptions
[Í≥µÏãùÎ¨∏ÏÑú](https://dev.mysql.com/doc/refman/8.0/en/aggregate-functions.html)

<BR>


# Î¨∏Ï†úÌíÄÏù¥
##  1. LeetCode - Rank Scores (DENSE_RANK())
[Î¨∏Ï†úÎßÅÌÅ¨](https://leetcode.com/problems/rank-scores/description/)

![show](../Images1/w2_1.png)

- scoresÏóê ÎåÄÌï¥ÏÑú ÎÇ¥Î¶ºÏ∞®Ïàú Ï†ïÎ†¨
- dense_rank() Ïù¥Ïö©
- order by score desc;

```SQL
SELECT 
  score,
  DENSE_RANK() OVER (ORDER BY score DESC) AS 'rank'
FROM Scores;
```

Ïã†Î∞ïÌïú Ïò§Î•òÏòÄÎçò Í≤ÉÏù¥ 'rank'Î°ú ÏûÖÎ†•Ìï¥ÏïºÌïúÎã§Îäî Ï†êÏù¥ÏóàÎã§.
Í∏∞Ï°¥ ÌîÑÎ°úÍ∑∏ÎûòÎ®∏Ïä§ÏóêÏÑúÎäî rankÎ°ú Î∞îÎ°ú Ïç®Ï§òÎèÑ Ïò§Î•òÍ∞Ä ÏïàÎÇ¨ÏóàÎäîÎç∞, Ïù¥ ÌîÑÎ°úÍ∑∏Îû®ÏóêÏÑúÎäî ÏòàÏïΩÏñ¥ rankÏôÄ Íµ¨Î∂ÑÌï¥Ï£ºÍ∏∞ ÏúÑÌï¥ Î¨∏ÏûêÎ°ú ÌôïÏã§Ìûà ÏÑ§Ï†ïÌï¥Ï£ºÎäî Í≤ÉÏù¥ Ï¢ãÏùÄ ÌîºÎìúÎ∞±? Ïù¥ÏóàÎçò Í≤É Í∞ôÎã§!


## 2. Îã§ÏùåÎÇ†ÎèÑ ÏÑúÏö∏Ïà≤Ïùò ÎØ∏ÏÑ∏Î®ºÏßÄ ÎÜçÎèÑÎäî ÎÇòÏÅ® üò¢
[Î¨∏Ï†úÎßÅÌÅ¨](https://solvesql.com/problems/bad-finedust-measure/)

### SOL1(ÎÇ†Ïßú ÏßÅÏ†ë ÏßÄÏ†ï)
![show](../Images1/w2_2.png)

```SQL
SELECT 
  m1.measured_at AS today,
  m2.measured_at AS next_day,
  m1.pm10,
  m2.pm10 AS next_pm10
FROM measurements m1
JOIN measurements m2
  ON DATE(m2.measured_at) = DATE(m1.measured_at, '+1 day')
WHERE m2.pm10 > m1.pm10;
```

### SOL2 (LEADÌï®Ïàò Ïù¥Ïö©)
![show](../Images1/w2_4.png)

```SQL
SELECT *
FROM (
  SELECT
    measured_at AS today,
    LEAD(measured_at) OVER (ORDER BY measured_at) AS next_day,
    pm10,
    LEAD(pm10) OVER (ORDER BY measured_at) AS next_pm10
  FROM measurements
) AS t
WHERE julianday(next_day) - julianday(today) = 1
  AND next_pm10 > pm10;
```


## 3. Í∑∏Î£πÎ≥Ñ Ï°∞Í±¥Ïóê ÎßûÎäî ÏãùÎãπ Î™©Î°ù Ï∂úÎ†•ÌïòÍ∏∞
[Î¨∏Ï†úÎßÅÌÅ¨](https://school.programmers.co.kr/learn/courses/30/lessons/131124)

![show](../Images1/w2_3.png)

### ÏÑúÎ∏åÏøºÎ¶¨ Î∞©Ïãù
```SQL
SELECT 
    P.MEMBER_NAME,
    R.REVIEW_TEXT,
    DATE_FORMAT(R.REVIEW_DATE, '%Y-%m-%d') AS REVIEW_DATE
FROM REST_REVIEW AS R
JOIN MEMBER_PROFILE AS P
ON R.MEMBER_ID = P.MEMBER_ID
WHERE R.MEMBER_ID = (
    SELECT MEMBER_ID 
    FROM REST_REVIEW 
    GROUP BY MEMBER_ID
    ORDER BY COUNT(*) DESC
    limit 1
)
ORDER BY R.REVIEW_DATE ASC, R.REVIEW_TEXT ASC;
```

### ÏúàÎèÑÏö∞ Ìï®Ïàò Î∞©Ïãù
```SQL
Ïò§ÎßàÏù¥Í∞ìÍ∞ì
```